- name: Upload systemd unit
  notify: systemctl daemonreload
  copy:
    src: zeitwork.service
    dest: /etc/systemd/system/zeitwork.service

- name: Build the main go app locally
  delegate_to: localhost
  command:
    cmd: go build -o /tmp/zeitwork cmd/zeitwork/zeitwork.go
    chdir: "../"
  environment:
    CGO_ENABLED: "0"
    GOOS: linux
    GOARCH: amd64

- name: Upload the binary to the remote host
  copy:
    src: /tmp/zeitwork
    dest: /data/zeitwork
    mode: 0755
  notify: restart zeitwork

- name: Generate zeitwork.env from template
  template:
    src: zeitwork.env.j2
    dest: /data/zeitwork.env
    mode: '0600'
  when: db_host is defined
  notify: restart zeitwork

- meta: flush_handlers

- name: Ensure zeitwork started and enabled
  systemd:
    name: zeitwork
    state: started
    enabled: true