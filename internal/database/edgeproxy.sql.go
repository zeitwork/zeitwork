// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: edgeproxy.sql

package database

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const getActiveRoutes = `-- name: GetActiveRoutes :many
SELECT 
    d.name as domain_name,
    v.private_ip as vm_private_ip,
    v.port as vm_port,
    v.region_id as vm_region_id,
    r.load_balancer_ipv4 as region_load_balancer_ip
FROM domains d
INNER JOIN deployments dep ON d.deployment_id = dep.id
INNER JOIN vms v ON dep.vm_id = v.id
INNER JOIN regions r ON v.region_id = r.id
WHERE d.verified_at IS NOT NULL
  AND dep.status = 'ready'
  AND v.status = 'running'
ORDER BY d.name
`

type GetActiveRoutesRow struct {
	DomainName           string      `json:"domain_name"`
	VmPrivateIp          string      `json:"vm_private_ip"`
	VmPort               int32       `json:"vm_port"`
	VmRegionID           pgtype.UUID `json:"vm_region_id"`
	RegionLoadBalancerIp string      `json:"region_load_balancer_ip"`
}

// Returns active routing information for the edgeproxy
// Joins domains → deployments → vms → regions
func (q *Queries) GetActiveRoutes(ctx context.Context) ([]*GetActiveRoutesRow, error) {
	rows, err := q.db.Query(ctx, getActiveRoutes)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []*GetActiveRoutesRow
	for rows.Next() {
		var i GetActiveRoutesRow
		if err := rows.Scan(
			&i.DomainName,
			&i.VmPrivateIp,
			&i.VmPort,
			&i.VmRegionID,
			&i.RegionLoadBalancerIp,
		); err != nil {
			return nil, err
		}
		items = append(items, &i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}
