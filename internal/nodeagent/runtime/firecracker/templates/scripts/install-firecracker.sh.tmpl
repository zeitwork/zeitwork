#!/bin/bash
set -euo pipefail

# Install Firecracker binaries
FIRECRACKER_VERSION="{{.FirecrackerVersion}}"
TEMP_DIR="{{.TempDir}}"
FIRECRACKER_URL="https://github.com/firecracker-microvm/firecracker/releases/download/${FIRECRACKER_VERSION}/firecracker-${FIRECRACKER_VERSION}-x86_64.tgz"

echo "Downloading Firecracker ${FIRECRACKER_VERSION}..."
cd "$TEMP_DIR"
wget -O "firecracker-${FIRECRACKER_VERSION}.tgz" "$FIRECRACKER_URL"

echo "Extracting archive..."
tar -xzf "firecracker-${FIRECRACKER_VERSION}.tgz"

# Find and install binaries
FIRECRACKER_BIN=$(find . -name "firecracker-${FIRECRACKER_VERSION}-x86_64" -type f | head -1)
JAILER_BIN=$(find . -name "jailer-${FIRECRACKER_VERSION}-x86_64" -type f | head -1)

if [[ -n "$FIRECRACKER_BIN" ]]; then
    echo "Installing firecracker binary..."
    install -m 755 "$FIRECRACKER_BIN" "{{.FirecrackerPath}}"
else
    echo "ERROR: Firecracker binary not found in archive"
    exit 1
fi

if [[ -n "$JAILER_BIN" ]]; then
    echo "Installing jailer binary..."
    install -m 755 "$JAILER_BIN" "{{.JailerPath}}"
else
    echo "ERROR: Jailer binary not found in archive"
    exit 1
fi

echo "Firecracker binaries installed successfully"
